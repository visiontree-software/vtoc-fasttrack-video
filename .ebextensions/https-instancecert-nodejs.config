###################################################################################################
#### Copyright 2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
####
#### Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
#### except in compliance with the License. A copy of the License is located at
####
####     http://aws.amazon.com/apache2.0/
####
#### or in the "license" file accompanying this file. This file is distributed on an "AS IS"
#### BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#### License for the specific language governing permissions and limitations under the License.
###################################################################################################

###################################################################################################
#### This configuration file downloads a private key from Amazon S3 and configures nginx to use it
#### to terminate HTTPS connections on port 443. Replace the values in the Parameters section with
#### the URL of the private key in Amazon S3, and the contents of the public certificate. To
#### download the file, your environment's instance profile must have S3ReadOnlyAccess or a similar
#### policy attached. In a single instance environment, also include 
#### https-singleinstance-securitygroup.config to allow traffic to the instance on port 443.
###################################################################################################

Parameters:
  privatekey: 
    Type: String
    Description: "The path to the private key in Amazon S3"
    Default: "https://aws-codestar-us-west-2-271621747356-fasttrack-video-pipe.s3-us-west-2.amazonaws.com/ssl/privatekey.pem"
  publiccert:
    Type: String
    Description: "The public certificate"
    Default: |
      -----BEGIN CERTIFICATE-----
      MIIEOjCCAyICCQDBoYtnk89zfTANBgkqhkiG9w0BAQsFADCB3jELMAkGA1UEBhMC
      VVMxEzARBgNVBAgMCkNhbGlmb3JuaWExEjAQBgNVBAcMCVNhbiBEaWVnbzEiMCAG
      A1UECgwZVmlzaW9uVHJlZSBTb2Z0d2FyZSwgSW5jLjETMBEGA1UECwwKaGVhbHRo
      Y2FyZTFHMEUGA1UEAww+ZmFzdHRyYWNrLXZpZGVvYXBwLmViYS0zd3E5eGlzMi51
      cy13ZXN0LTIuZWxhc3RpY2JlYW5zdGFsay5jb20xJDAiBgkqhkiG9w0BCQEWFWpw
      cmljZUB2aXNpb250cmVlLmNvbTAeFw0yMDA1MDYxNTEwMTNaFw0yMTA1MDYxNTEw
      MTNaMIHeMQswCQYDVQQGEwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTESMBAGA1UE
      BwwJU2FuIERpZWdvMSIwIAYDVQQKDBlWaXNpb25UcmVlIFNvZnR3YXJlLCBJbmMu
      MRMwEQYDVQQLDApoZWFsdGhjYXJlMUcwRQYDVQQDDD5mYXN0dHJhY2stdmlkZW9h
      cHAuZWJhLTN3cTl4aXMyLnVzLXdlc3QtMi5lbGFzdGljYmVhbnN0YWxrLmNvbTEk
      MCIGCSqGSIb3DQEJARYVanByaWNlQHZpc2lvbnRyZWUuY29tMIIBIjANBgkqhkiG
      9w0BAQEFAAOCAQ8AMIIBCgKCAQEA5DDRJ7uC6HfoOtfU8D1RKQh5xaamAgO7n7D5
      OqJ7eZDKgnBIfQJd3BN8/tQTrc9LYwqMNmyPurr+EheSmzCwaORsHneqCC6jrcHw
      rEQWBhk5aSPWkz1ub5cSCaXKbvbFO0t5/+FeNpr9O0/keDpW7XHOobuDX3DvsbXj
      9XZteGe7muxb2JLw7fv4vQ9BLU9F+t51QfSKHlUDr3zE4uYTJ+COikn/7lJ+RQr+
      zUb/DLpK3AIyGuD7xOqh8bpYVZK7q3cXgYu90m7VAu6OLEO4Yv41SOGtolt+MgkM
      jVk6Hm/ZmMMvKvvjGiTVFfdFjG0z6MpfKrQi61f5+o6cUqGlbQIDAQABMA0GCSqG
      SIb3DQEBCwUAA4IBAQCNOXNwX1iibYTK1SP/fsWYXMH8fzYK32ZJbemrZCORsFT7
      zFwxsvAjcECJWakcrJ4gSMDP29tAdpv5ZYB4kLaS5vb1hWFfgs/zt0GTHgriAmv5
      i6rHVkO0L5vEKHQJDo6dAbYH1J19bZYTJ/y1FHCWBSdQfqTZ/ZCEMXPYZzb6oqXI
      PWJysW9MXTLBR1s/qf6WwkRxEAWwDjOuv+42mIX1i9z0uCnD5zuLKM3w7to5DgH4
      5VHgVLAgVitBjumg8cmWUrg/Z07nz0uw38YdSVDYB/Cb9DsvAqM39wKzOpsCaPSH
      4LD+uNDK8ZfShvYxQEwFmnMGRU2WUQIghTHstNgg
      -----END CERTIFICATE-----

##############################################
#### Do not modify values below this line ####
##############################################

files:
  # nginx HTTPS configuration
  /etc/nginx/conf.d/https.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      # HTTPS server

      server {
          listen       443;
          server_name  localhost;
          
          ssl                  on;
          ssl_certificate      /etc/pki/tls/certs/server.crt;
          ssl_certificate_key  /etc/pki/tls/certs/server.key;
          
          ssl_session_timeout  5m;
          
          ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
          ssl_prefer_server_ciphers   on;
          
          location / {
              proxy_pass  http://nodejs;
              proxy_set_header   Connection "upgrade";
              proxy_http_version 1.1;
              proxy_set_header        Host            $host;
              proxy_set_header        X-Real-IP       $remote_addr;
              proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
          }
      }

  # Public certificate
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: { "Ref": "publiccert"}

  # Private key
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    authentication: "S3Auth"
    source: { "Ref" : "privatekey" }

Resources:
  # Use instance profile to authenticate to S3 bucket that contains the private key
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Access:
          type: "s3"
          roleName: 
            "Fn::GetOptionSetting": 
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"
